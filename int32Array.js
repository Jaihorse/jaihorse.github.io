const LGHT=0,DARK=1,L_PWN=0,D_PWN=1,L_HRS=2,D_HRS=3,EMPTY=4,NOUSE=5,pcConv=new Int32Array([1,3,5,7,8,10,12,14,17,19,21,23,24,26,28,30,33,35,37,39,40,42,44,46,49,51,53,55,56,58,60,62]),sq32=new Int32Array(64);for(let e=0;e<32;e++)sq32[pcConv[e]]=e+1;let side=0,pc=new Int32Array(64),moveList=[],step=0,curStep=0,boardHistory=[];const canvas=document.getElementById("board"),ctx=canvas.getContext("2d");canvas.style.width="320px",canvas.style.height="320px";const COLW=40,COL_NOUSE="#4f6b7a",COL_EMPTY="#2a3b47",COL_LGHT_PAWN="#b3c2cc",COL_DARK_PAWN="#0f1a22",COL_LGHT_RING="#7f98a8",COL_DARK_RING="#3a5566",bk_map=new Map;let bkdbLoaded=0;async function loadBKDB(e="DB0508.zip",t="DB0508.txt"){const n=await fetch(e),o=await JSZip.loadAsync(await n.blob()),c=(await o.file(t).async("text")).split("\n").map(e=>e.trim()).filter(e=>e.length>=21);for(const e of c){const t=BigInt("0x"+e.substring(0,16)),n=Number("0x"+e.substring(16,21));bk_map.has(t)||bk_map.set(t,[]),bk_map.get(t).push(n),bkdbLoaded++}console.log("Book loaded:",bkdbLoaded)}function boardEncode(){const e=[4n,5n,6n,7n],t=[5n,4n,7n,6n];let n=0n;if(0===side)for(let t=0;t<32;t++){const o=pc[pcConv[t]];n=n*(o>=4?2n:8n)|(o>=4?0n:e[o])}else for(let e=31;e>=0;e--){const o=pc[pcConv[e]];n=n*(o>=4?2n:8n)|(o>=4?0n:t[o])}return n}loadBKDB();const FM=e=>255&e,TO=e=>e>>8&255;function resetBoard(){for(let e=0;e<64;e++)pc[e]=(e>>3)+(7&e)&1?4:5}function initPieces(){resetBoard();for(let e of[0,1,6,7]){const t=e<2?1:0;for(let n=0;n<8;n++){const o=8*e+n;5!==pc[o]&&(pc[o]=t)}}side=0,updateSideRadios(),draw()}function clearBoard(){resetBoard(),draw()}function setSide(e){side=e,updateSideRadios()}function flipSide(){side^=1,updateSideRadios()}function updateSideRadios(){sideLight.checked=0===side,sideDark.checked=1===side}function reverseBoard(){const e=pc.slice();for(let t=0;t<64;t++)pc[63-t]=swapColor(e[t]);flipSide(),draw()}function swapColor(e){return 0===e?1:1===e?0:2===e?3:3===e?2:e}function parseMoves(e){return e.trim().split(/\s+/).map(e=>{const t=e.includes("x"),[n,o]=e.split(t?"x":"-");return{from:parseInt(n,10),to:parseInt(o,10),cap:t}})}function loadMoves(){initPieces(),draw();const e=moveInput.value.trim();if(!e)return moveList=[],curStep=0,void(stepInfo.innerText="ไม่มี move");moveList=e.split(/\s+/),curStep=0,stepInfo.innerText="โหลดแล้ว "+moveList.length+" moves"}function gotoStep(e){curStep=Math.max(0,Math.min(e,moveList.length)),initPieces();for(let e=0;e<curStep;e++)applyMove(moveList[e]);draw(),stepInfo.innerText="Step "+curStep+"/"+moveList.length}function stepFirst(){gotoStep(0)}function stepBack(){gotoStep(curStep-1)}function stepNext(){gotoStep(curStep+1)}function stepLast(){gotoStep(moveList.length)}function applyMove(e){if(e.includes("x")){const[t,n]=e.split("x").map(e=>parseInt(e,10));doCapture(t,n)}else{const[t,n]=e.split("-").map(e=>parseInt(e,10));doMove(t,n)}}function doMove(e,t){const n=pcConv[e-1],o=pcConv[t-1],c=pc[n];4!==c&&(pc[o]=c,pc[n]=4,0===c&&t<=3?pc[o]=2:1===c&&t>=28&&(pc[o]=3))}function doCapture(e,t){const n=pcConv[e-1],o=pcConv[t-1];doMove(e,t),p=n>o?(7&n)>(7&o)?o+9:o+7:(7&n)>(7&o)?o-7:o-9,4!==pc[p]&&(pc[p]=4)}function checkBook(){if(!bkdbLoaded)return;const e=document.getElementById("bkinfo"),t=(document.getElementById("betterBox"),BigInt(boardEncode())),n=t.toString(16);document.getElementById("boardKey").value=n;const o=bk_map.get(t);if(o){const t=new Map;for(const e of o)t.set(e,(t.get(e)||0)+1);const n=[...t.entries()].sort((e,t)=>t[1]-e[1]);let c="";for(const[e,t]of n){const n=255&e,i=TO(e),s=(100*t/o.length).toFixed(1);c+=`${sqBySide(n)}-${sqBySide(i)} (${s}%)\n`}e.innerText=c,submitBtn.style.display="inline",submitInfo.innerText=""}else e.innerText="ยังไม่มีใครสอน"}function sqBySide(e){const t=sq32[e];return 0===side?t:33-t}function draw(){for(let e=0;e<8;e++)for(let t=0;t<8;t++){const n=8*e+t;if(ctx.fillStyle=5===pc[n]?"#4f6b7a":"#2a3b47",ctx.fillRect(40*t,40*e,40,40),pc[n]<=3){const o=40*t+20,c=40*e+20,i=1&pc[n];ctx.fillStyle=i?"#0f1a22":"#b3c2cc",ctx.beginPath(),ctx.arc(o,c,40/3,0,2*Math.PI),ctx.fill(),pc[n]>=2&&(ctx.strokeStyle=i?"#3a5566":"#7f98a8",ctx.lineWidth=2,ctx.beginPath(),ctx.arc(o,c,8,0,2*Math.PI),ctx.stroke())}5!==pc[n]&&(ctx.fillStyle="#8fa3b0",ctx.font="9px monospace",ctx.textAlign="right",ctx.textBaseline="top",ctx.fillText(sq32[n],40*t+40-3,40*e+3))}printBoardCode(),checkBook()}const sym=["o","x","@","#","."];function printBoardCode(){let e="";for(let t=0;t<32;t++){const n=pc[pcConv[t]];e+=sym[n<=4?n:4]}document.getElementById("boardCode").value=e,document.getElementById("bkinfo").textContent=""}function loadFromCode(){const e=document.getElementById("codeInput").value.trim();clearBoard();const t=Math.min(e.length,32);for(let n=0;n<t;n++){const t=pcConv[n],o=e[n],c=sym.indexOf(o);-1!==c&&(pc[t]=c)}draw()}function copyBoardCode(){const e=document.getElementById("boardCode").value;prompt("Plese copy this:",e)}function submitBetterMove(e=!0){const t=document.getElementById("moveType");fetch("https://chnp.co.th/makhos/bettermove.php?code="+encodeURIComponent(boardCode.value)+"&side="+side+"&type="+encodeURIComponent(t.value)+"&move="+encodeURIComponent(betterMove.value)).then(e=>e.text()).then(t=>{e&&alert("ส่งข้อมูลเรียบร้อยแล้ว ขอบคุณครับ"),submitInfo.innerText=t,betterMove.value=""})}document.addEventListener("DOMContentLoaded",()=>{submitBetterMove(!1)});let selectedPiece=0;function setPieceRadio(e){const t=document.getElementsByName("piece");for(let n of t)if(Number(n.value)===e){n.checked=!0;break}selectedPiece=e}document.querySelectorAll('input[name="piece"]').forEach(e=>{e.onchange=()=>{selectedPiece=Number(e.value)}}),canvas.onclick=e=>{const t=e.offsetX/40|0,n=8*(e.offsetY/40|0)+t;if(5!==pc[n]){if(pc[n]<=3){const e=pc[n];pc[n]=4,setPieceRadio(e)}else pc[n]=selectedPiece,side=1&selectedPiece?0:1,document.getElementById("sideLight").checked=0===side,document.getElementById("sideDark").checked=1===side;draw()}},resetBoard(),draw();