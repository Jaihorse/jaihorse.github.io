const image_src = [
  "heipwn.jpg","peppwn.jpg","heihrs.jpg","pephrs.jpg"
];

const message = [
  "Welcome to Sunhorse", 
  "Sunhorse is thinking..", 
  "Now, your turn",
  "You won, please play new game", 
  "You lost, please play new game",
  "Draw, please play new game"
];

const board = new Array(64).fill(0);

function initBoard() {
  for (let i = 0; i < 24; i++) board[i] = (i % 2 === 1 ? 2 : 0);
  for (let i = 40; i < 64; i++) board[i] = (i % 2 === 1 ? 1 : 0);
}

function drawBoard() {
  const c = document.getElementById("sunhorseCanvas");
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  const s = c.width / 8;
  for (let r=0; r<8; r++){
    for (let c2=0; c2<8; c2++){
      ctx.fillStyle = ((r+c2)%2===0)?"#dcb": "#530";
      ctx.fillRect(c2*s, r*s, s, s);
      const v = board[r*8+c2];
      if (v){
        ctx.fillStyle = v===1?"#fff":"#f00";
        ctx.beginPath();
        ctx.arc(c2*s+s/2, r*s+s/2, s*0.35, 0, Math.PI*2);
        ctx.fill();
      }
    }
  }
}

async function getGoogleAIMove() {
  const response = await fakeGoogleAiApi(board); 
  if (response && response.move) {
    const { from, to } = response.move;
    doMove(from, to);
  }
}

function doMove(fromIndex, toIndex) {
  board[toIndex] = board[fromIndex];
  board[fromIndex] = 0;
  drawBoard();
}

function fakeGoogleAiApi(currentBoard) {
  return new Promise((resolve) => {
    setTimeout(() => {
      const myPieces = currentBoard.map((val, idx) => val === 2 ? idx : -1).filter(idx => idx !== -1);
      const randomStart = myPieces[Math.floor(Math.random() * myPieces.length)];
      resolve({
        move: { from: randomStart, to: randomStart + 8 }
      });
    }, 1000);
  });
}

let neutonLayer1 = Uint32Array() [
   601627888, 2728506149, 4138808047, 4172626265,
    83772949,  899500947, 1911190145, 4293703031,
   319647034, 3694726753, 1395152184, 3435992711,
  3360565935, 2786312517, 1219987021, 1766700815,
  3637027826,  644849455, 2250555633,  830992675,
  2359028342, 3148691469, 1165893860, 1949897493,
  2337081204,  266808801, 1431132067, 1338147882,
  2996327760, 1719894839,   36353964,  187499743,
   355934776, 3244499390, 1406121743,  297861894,
  2666870201,  596175705, 2185785982, 2966967842,
   877204493, 3412823711, 1407106905, 4016643311,
  3524301021,  217571939,  717492200, 3920427935,
  1036837885, 3811134062,  828282847, 3137810130,
  1018040685, 2872496217,  534603024, 4044017291,
  3319969878, 1951144065, 3744034013, 3311655644,
  2136255178, 3170276877, 1782885203, 1764444543
]

let neutonLayer2 = Uint32Array() [
   366029284, 2934895371, 3881473720, 3281103636,
  2224365376, 3309703940, 2233040265, 1410585640,
  4178132048, 2560904299, 1548104827, 1721632580,
  4179842439, 1352964510,  724207365, 3448094060,
  4284021811, 2760781612, 1796968033,  190928777,
  3705395065, 2909337845,  669088428,  935629690,
   988592213,  520641060, 1311896791, 1471599629,
  3622708124, 2163084289,  897941189, 1307073009,
  3934101284, 3037338149, 3708815108, 2820296064,
  1117993583,  487089135, 2504541589, 1401268151,
   531044274, 3557172016, 1293348621, 1516240774,
  3956976633, 1155921898, 1654167963, 1397199594,
  1273577204, 3451638698, 1458117537,   75353406,
  1409289741, 2231113129, 2786459885, 4189147062,
  1951603799, 3252748952, 3824191148, 3550073315,
  1172545771, 2807884898, 3360941653, 2129357859
]

let neutonLayer3 = Uint32Array() [
   663988870, 1997565812, 3673342228, 1785023375,
  4155889294,  814328666, 4024354385, 3679296520,
  1966849155,  159861071,  360318163, 2163936056,
   242557239,  538277725, 3102311725, 3873233148,
  2995451865,  283275401, 3527373024, 3216609530,
  1640009240, 2661955713, 1520803147,  284270505,
  3324275480, 2319432889, 1263028750, 3394781206,
  1548453818, 2069072858,  108517442, 1848267814,
  2125666349,  252192831,  251261694, 1191361677,
  1860306510, 1836396169, 2733958466, 2157687966,
   348164205, 2402239030, 2897356910, 1172146892,
  2601296100, 1875709794,  852899724, 3449512737,
  3578715732,  674160737, 1410603858, 1891435033,
  2458007404, 3725257336, 2352950657, 2644018079,
  3516135296, 3861338964, 3984083381, 1953117438,
  1135992245, 3225791471,  585044802, 4031769637
]

let neutonLayer0 = Uint32Array() [
  1285392585, 1532115539, 2677369616, 4255218290,
  2176206279, 1360527962, 4048649795, 1283428824,
  4155074709,  771394348, 1175293752, 2995999154,
  1552799056, 3927598600, 3432893172, 1156911812,
  3557373112, 3492970625,  413508665,  454063527,
  2261625098, 1640805368, 1174994242, 3183863092,
  2815892152, 3448978863, 2061698081, 1809600953,
  4138956239, 2506448912, 1570467452, 4131014269,
  3027871807, 1807487059, 4275206722,  920468295,
   308311988, 2283549529, 3244887222, 3700443947,
  1284997282, 3050572875, 2726375095,   33522221,
  1776873877, 1616794640, 2953160051, 3071877838,
   615618631, 3590894219, 1841754430,  384348506,
  2540264408, 1761333714, 3828786231, 2047796205,
   422716174, 1510969458, 3603453739, 3983862979,
  1216581862, 3415471324, 2064455664, 3967839928
]

let neutonMultiply = Uint32Array() [
  4072147329,  761002317, 3223684671, 2660079335, 2524537233,
   553800787, 2660171859, 3243891453, 2069998665, 1958427549,
  2923689795, 4071819856, 3782765435, 3897396215, 2836104512,
  4164719474, 3733329183, 2032320703,  156236637, 2898485689,
   777632023, 1525647280, 2259952100, 1371513115, 2643298453,
  3509442618, 4197436269, 3941363587, 1633704163,  457558817,
  2646978511, 3689072826, 4215220090, 2339550039, 2347556855,
  2952395614, 3994013588, 3020423659, 3049397215, 4109143018,
  2291412883, 1369999451, 1051248591,  624736404, 3681931137,
   848563609, 2168927953, 1765106101,  733437319, 3906737492,
  3697658430, 2608404319, 4026244945, 3320409954, 2095445677,
  3972669611, 4053690051, 1367746201, 4202681012, 3675786465,
  2123928767,  566955784, 2413416353, 3977998470, 1021233300,
  2018485868,  157599899, 3884275501, 2883778698, 1259841550,
  1655447300, 4147940797,  649644902, 3746450973, 3178360457,
  1089188421, 2404787429,  102664083, 1637610449, 4099472679,
  1498136473, 3966216834, 2527531591,  889611423, 3069548074,
  1640696260, 2162492591, 3963215898, 2193570780, 1519883880,
  1496059138, 2323072275,  495304093,  757537653, 2645362010,
  2324293236,  238151730, 1898977259, 1049643139, 4079701881,
  1517138223, 1502823393, 3591482283, 4189783276, 1271136456,
  2675297370, 1156205856, 2570040965, 3653290504, 3029808104,
    21692632, 3485933300, 4280382563, 1621446816, 2176673852,
  3258206278, 1840244828, 2397212738, 1958982447, 1804660003,
   258239008, 1145318977,  145751175, 3352797462,  566591965,
  1720909569, 1261211160, 2032024745,  507078957, 1429658104,
  2517245370, 1318095131, 3362861601, 2335483419, 3965524830,
  3172495284, 3015247813,  842856057, 1719792078, 1418425856,
  1514314960, 3199012704, 2160712392, 1691666101, 2016369464,
   778631781,   96064679, 1032535084, 4108955033, 2779533529,
  3193229790,  453280257, 2126366647,  186522333, 2279268836,
  2542720054, 2255077164, 3245936033, 3783774541,  198898262,
  1902000950, 3833851708, 3047793216, 3474065212, 1624408628,
  2219918935, 2808615047,  966929973, 1297599911, 2999995276,
   653275058, 2649712147, 3487147241, 3450229567,  496091711,
  4117613130, 1332006735,  242468200, 3093125106, 1768434622,
   904953289, 3752800518, 4180249126, 2033874111, 3314236555,
  2635151427, 3296512825, 2036577344,  494265664, 2821419928,
    73015650, 1925893565, 2564241682,  418460256, 3166343801,
  2628176497,  339834984, 3715975851, 1332242700, 1385696129,
  2650581760, 1509880109,  775313876, 1498581597,  960760476,
  3644242802,   30508995, 1422286104, 3819463021, 2034567580,
  1435721118, 1717870741,  123457641,  728921236, 1464059126,
  2654547908, 1066801133, 1673621380, 1521807885, 3030512923,
  2886406788, 3119851330,  492384273, 2796216324, 4241934990,
  2145443403, 3069608043,  982058983, 3067618933, 2600164397,
    39698524,   40695605, 1962475241, 4262830353, 4048361719,
  2627555623, 2175762392, 3372904872, 3313611034, 3675655087,
  2082672837,  286423404, 2680965605, 1986734577, 1005014948,
  4163111787, 2954326247, 2959557104,  567153219, 1669414884,
   485313213, 4141579027, 3886300699, 1125868196, 1068469046,
  3077078423, 2887201424, 2618779969,  950024209, 3787143306,
  2732933367, 1411913774, 1995958016, 1509622006, 3558056950,
  4016757957, 1831222956, 3640562869,  276232523, 1938622326,
  3499302758, 3267321539,  899286095, 2472476360,   40179017,
  2112497113, 2738004921, 3782090367,  418721973, 1483386691,
   506204349, 1084520973, 2078554698, 3869932987, 4081533660,
  2810682724, 3972831600, 1891538039, 2879537263, 3289458750,
  1963984437, 1241914358, 2188895098,  101976476, 2845616219,
  3648535789, 2709167523,  580545717, 2689353287, 2859927633,
  2667755306, 2231457120, 4201223104, 2607582664, 1574182009,
   861915627,  384738544, 3571443682, 1380044576,  380682528,
   195947678,  855832668,  253389423, 3527342044,  454046092,
  1000582629, 4108893096, 1671523161, 2710243437, 2955782372,
  1550646289, 4016299883, 1130725344, 2553850472, 2580493445,
  2008114412, 1130688346, 3566210496, 1450912131, 2440238119,
  3858566213, 2325014524,  628825236, 1399418873, 1094154862,
  1488005269, 1155086010, 1842047203, 2308621633, 3459095124,
   483097270, 2816557290, 3653089477, 2696293309, 1604545613,
   981098890, 1640751112, 1420051998,  691694648, 3749075781,
  1902215950, 3490064636, 1166920649, 2140192724, 2479414099,
  3340832342, 1595973655, 3192954956, 3069790895, 2359515400,
   602751539, 3601021683, 1313999734, 2689284209, 1521756009,
  4163968005, 4194930865, 1624841925, 2618984461, 3266249340,
  1875993186, 1275484610, 2263523146,  143154564, 3057072752,
  2139488130, 1660889942,   75050546, 1429857383, 1855111295,
  1683317951,  883399804, 1955524168, 2429010849, 3514049202,
  1724148372, 1777451452, 1547905190, 4287182228, 2719109635,
  3455010592, 3758792991,  687199242, 2960200945, 2259839548,
  1652009129,  927749543, 1041289942, 3696823722, 1709481743,
  2900654634, 3936659527, 1546003508, 2665375312, 3642737719,
  3704931126, 1924238574,  423239534, 2494528510, 4136814838,
   115041993, 4155879951,  500943321,  414765029, 2562644795,
  1971695595, 1615218458, 1317459638,  574528025, 4096294705,
  2116886352,  184438017, 1902745099, 4141004058, 1789945818,
  2374155811, 2838382748, 3207814455, 1568296086, 3589400175,
  4236698856, 1342310130,  951041320, 4226335014, 2380687005,
  2060108313,  371106242,  116821204, 3399175092, 2220795536,
  1809739338, 2022691118,  858305088, 1505547812, 2265879003,
  1094830911, 1378309928,  116203051, 2454468075,  605714654,
  2884519483, 2769114197, 3219902306,  692847207,  671096701,
  2042904305,  819439810, 1068378349,  902094453, 3846357982,
  3866734701,  507671610, 4260455947, 2823316119, 2518886279,
   207074916,  323451154, 1893767391, 1392967265, 1634519173,
  2724468000,  915028459, 3865653989, 1116505380, 1279668177,
  1104110750, 1292813441, 3820676574,  472985445, 3845395509,
   918980511, 3753745432,  524089836, 3218409214, 2636466299,
  1027122239,  428057971, 2031026363, 3857931018, 2421612057,
  1879201803, 4263942204,  933763955,  678950851, 2122155203,
  3219544531, 3712003129,  754066076, 3827554347, 3615544382,
  4155955080, 3451397595,  683279909,  386323428, 3180150020,
   583338768, 1047359810,  315285532, 3784394138, 2216863470,
  1973509664, 4253915672, 2258147320, 3970538677,  977006752,
  3425693749, 2091947797, 2259774060, 2906522286, 3107676453,
  1457386117, 3016395960, 3731966070, 1871068676,  646382894,
  1927000183, 2808838118, 3183533264, 3935123424, 3968773495,
  2566757181, 4041671945, 1800880134, 4274188490, 2709567592,
   349700247, 2868089407, 1536249291, 3963480634,  397691712,
  2030780677,  278576892, 2384957391,  105585457, 2988269684,
  2691450920, 1589781145, 1161021303,  976109635, 3662456650,
   369620972, 2982778619, 2097248181,  343556529, 1445324414,
  3458721048, 1749721568, 1637563279, 1945541876, 3702540189,
  3362869454, 1337115318, 4199377147, 2368002161,  474547926,
  2852001393, 4166652059, 3520493312,  650224670, 1131181416,
  2723761039,  856672164, 3452665529, 1520781640, 3204117587,
  3644739706, 2322251186, 3529109858, 1337724463,  606147955,
   380625146, 1637550246, 3697422166, 3283970812, 2163512638,
  3025179118, 3820091310, 3085039552, 3251477803, 1783323704,
   302905203,  490167498, 2689951582, 2157496955, 1228757203,
   129748380,  518968992,  750597739,  834281479,  447585295,
   392685176, 1132408477,  509420692, 2224468915, 1442743710,
   745498106, 3261021559,  446561257, 4066532949, 1866794255,
  1194303924, 3373024194,  749567813,  317710318,  440740936,
  2748689750, 3967557291,  154159757, 3209794228, 2569998942,
   701278239,  694440755, 2979194722, 2906359915, 3723092354,
   381874380, 3121806562, 3928585869, 1797765750, 2953614946,
  3312187964, 4238409491, 2819107107, 2749527022,  512371242,
   399811925, 2615459109, 3407269518, 1244290101,  818365283,
   752878668, 2756841587,  163518722, 2480222844,  631668607,
  1301946871, 4236861737, 2702823968, 1475484692, 3654494302,
  1229492622, 1525153684,  535036440, 1117746703, 1459770900,
  3535910286, 1878530004, 4259520641,  716499313, 4282998864,
  2735104749, 4269313860, 1826077283,  703531894, 1679989826,
  1857792070, 2095269612, 2198816546,  386418641, 2329486909,
   661100405, 2540168821, 1005184279, 4068552380,  114668959,
  2820748472, 2799378960, 3142036331, 1749621483,  890624972,
  3875253111, 4128831051,  990067799, 2889870018,  256116528,
  1180283850,  826780400,  989875352, 2354196236, 3211270160,
   349809231, 4147484345, 1601766777, 2337317446, 2836412154,
  2097557694, 2606035102, 1803669275,  717300660, 3910431056,
  1292593437, 2641515634, 3127674580, 3914849692, 3699379638,
  3227300244, 3566882192,  945077337,  357305843,  733605389,
  3979469223,   65139082, 3723544678, 1730742642, 2057573760,
   635260016, 3584137493, 2530260173, 4020108633, 1275158634,
   695828245,  528733941,  667035170,  925890590, 1864988927,
  3189508044, 2118873950, 2318032020, 2697610409, 3221669333,
   271678177,  743387640, 2667861318, 2922520122,  370901070,
  1975868315,  118342345,  809378949, 2330420091, 3544465619,
   712593639, 1464413020, 2905290144,  854838161, 2156471358,
  1001063187, 2928465451, 3119234137, 1691984615, 1509600009,
    93782129,    9321145, 2045167353, 2188649462, 2783541436,
  4222078904, 2826879468, 2776237549, 2192855839, 3701666294,
  2857845736, 1360660559, 1527921984, 1293580942,  235549744,
   356980396, 3151512385, 2972007487, 3695339423, 3289850596,
  2048367300, 4001995425,  159748922, 1852615442, 3680888697,
  1186243047, 2574704137, 2947604704, 2436298575,  880117269,
  4153668261, 1152871182, 2410367097, 2140155753,  856309638,
  2759168977, 2500009988, 2948529981, 3122945281, 3624984475,
  2338336210, 2525283211, 2919538023, 2230687096,  104354905,
  1385874848,  887931072, 3462071632, 4286082571, 1705191081,
    34445105,   55010505, 1767734480, 1917184048, 1885516502,
  2822379860, 2525416605,  879031829, 1657470848, 3793478505,
   723737431,   60578709,  248232012, 4216186348, 2147803371,
  3562521438, 3045812163, 1036696248, 1271569287, 2062560793,
  2386516350, 2770300579, 2641789292,  298275923, 1392502204,
  1706517581, 3142149912, 2370799783, 3782884270, 3934610189,
  3514712501, 3606598106, 3321074420, 1639347240, 3503133929,
  3041849352, 4097893155,  811611874, 3373266458, 1603508557,
  3032363076, 1150814047, 4278486558, 3878515385, 3016299351,
  1561919507, 2760125076, 4253666824, 1753116258, 1163361185,
  1283771075,  572084823, 3564740469, 1169857383, 4085414596,
  2575650399, 4003382537, 1686806567,  176910081, 4193895215,
   905884557, 3068720885, 1914645474, 1660324172,  712413813,
  3827597145, 3965547076, 3500628401, 2181847421,   69349549,
  3648694462, 2544491157, 2271271315,  654434415,  402719600,
  2919201573, 3924328632, 3556165423, 3295876604,  747840118,
   169914309,   44787272, 3718301610, 4059902045, 1245989580,
  3508006101, 1584732042, 1934383096, 3775805336, 1312193464,
  4130688178, 3747072718, 3486278605, 1338876606, 2043224051,
  1781337272, 1640238918, 1087516065, 3575884776,  786120566,
  3029450398,  433710855,  943571242, 2614812532,  868340000,
  3121103396, 3786762960, 2388773291,  767963268, 1891826598,
   523068036, 1256055370,  697062648, 2165930948, 1772848002,
  1783200005, 1130201729, 1035932713, 2013871117, 3003743213,
  3072506616, 1125709454, 1431149378, 4225249755, 4073355960,
  2969806192, 3910444885, 1472515103,  891296535, 2454533601,
  2213232201, 1907516096, 1660527905, 1759300855, 1848197320,
   885644900, 3811869043, 1420145414, 4192764060,   86514512,
  2355665633, 1836833736,  656131468, 2103375470,  938774235,
  1675389522, 3448767795, 1595300322, 2138543579, 1580485372,
   945157170, 1930568234, 2013416038,  116966427, 2289105389,
  3526123705, 3317692735, 3523601803,  260769328, 2955449563,
  2327797002, 4050461946, 1724392506, 2487919111, 3343676523,
   944612566, 1330939744, 2492854727, 3948444769, 3068243346,
   897807056,  203840798, 2466443605,  259490592, 1451441557,
  2077508164, 3308743120, 2456894553, 1102287405, 3700355102,
  1426411408, 1574637992, 3714998699, 3821811398, 2043425422,
  3352176315, 1443535824, 4033658563,  219168086, 2790666422,
  3206185512,  821591123, 1552043942, 3131445165, 1460126562,
  2437577465, 1407992619, 2992811233, 2146938684, 2286818955,
  1110151531, 2954068212, 3755704923,  232985284, 2329130673,
  2812021313, 1040520742, 3727641231, 1478820208, 2158421005,
   242996141, 1258557323, 1816721490, 3359382494, 4049070762,
  2275789693, 3060678017, 2917246264, 1483462791,  878240131,
  2104556578, 3167549931,  859277285, 4060026108
]

function aiMove(){
  const pc = board.slice();
  const L1 = neutonLayer1();
  const L2 = neutonLayer2();
  const L3 = neutonLayer3();
  const L4 = neutonLayer3();
  const L0 = neutonLayer3();
  const Lx = neutonMultiply();

  let score = 0;
  for (let i=0;i<64;i++){
    score += pc[i] * L1[i] * L2[i] * L3[i];
  }

  const moves = legalMovesCPU();
  if (moves.length)
    doMove(moves[Math.floor(Math.random()*moves.length)]);
}

function legalMovesCPU(){
  const m = [];
  for (let i=0;i<64;i++){
    if (board[i]===2){
      const r = i>>3, c = i&7;
      const d1 = (r+1)*8 + (c-1);
      const d2 = (r+1)*8 + (c+1);
      if (c>0 && d1<64 && board[d1]===0) m.push([i,d1]);
      if (c<7 && d2<64 && board[d2]===0) m.push([i,d2]);
    }
  }
  return m;
}

function doMove([a,b]){ board[b]=board[a]; board[a]=0; drawBoard(); }

window.onload = () => {
  const c = document.getElementById("sunhorseCanvas");
  const dpr = window.devicePixelRatio || 1;
  const size = Math.min(window.innerWidth, window.innerHeight);
  c.style.width = size + "px";
  c.style.height = size + "px";
  c.width = size * dpr;
  c.height = size * dpr;

  initBoard();
  drawBoard();
};
